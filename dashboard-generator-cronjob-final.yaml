apiVersion: v1
kind: ServiceAccount
metadata:
  name: dashboard-generator
  namespace: internal
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: dashboard-generator
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "create", "update", "patch"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dashboard-generator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: dashboard-generator
subjects:
  - kind: ServiceAccount
    name: dashboard-generator
    namespace: internal
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: dashboard-generator
  namespace: internal
spec:
  schedule: "*/10 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: dashboard-generator
        spec:
          serviceAccountName: dashboard-generator
          restartPolicy: OnFailure
          initContainers:
            - name: install-tools
              image: alpine:latest
              command:
                - /bin/sh
                - -c
                - |
                  apk add --no-cache curl
                  curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                  chmod +x kubectl
                  mv kubectl /tools/kubectl
              volumeMounts:
                - name: tools
                  mountPath: /tools
          containers:
            - name: generator
              image: alpine/git:latest
              command: ["/bin/sh", "-c"]
              args:
                - |
                  apk add --no-cache bash jq gettext
                  /bin/bash /scripts/generate-dashboards.sh
              env:
                - name: GITLAB_URL
                  valueFrom:
                    secretKeyRef:
                      name: gitlab-dashboard-credentials
                      key: GITLAB_URL
                - name: GITLAB_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: gitlab-dashboard-credentials
                      key: GITLAB_TOKEN
                - name: GITLAB_REPO
                  valueFrom:
                    secretKeyRef:
                      name: gitlab-dashboard-credentials
                      key: GITLAB_REPO
                - name: GITLAB_BRANCH
                  valueFrom:
                    secretKeyRef:
                      name: gitlab-dashboard-credentials
                      key: GITLAB_BRANCH
                - name: DASHBOARDS_PATH
                  valueFrom:
                    secretKeyRef:
                      name: gitlab-dashboard-credentials
                      key: DASHBOARDS_PATH
                - name: PATH
                  value: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/tools"
              volumeMounts:
                - name: script
                  mountPath: /scripts
                - name: tools
                  mountPath: /tools
          volumes:
            - name: script
              configMap:
                name: dashboard-generator-script
                defaultMode: 0755
            - name: tools
              emptyDir: {}
